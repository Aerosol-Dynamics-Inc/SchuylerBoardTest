/*
 * TemperatureLookUp.c
 *  
 *  Convert from ADC value to Temperature in 100ths of a Degrees C.  Table for EPCOS B57861S103A39 10K thermistor to GND in series with a 10K Ohm resistor to +V.
 *    Table was generated using the Igor function in the file at the bottom of this file.
 *
 *    VALUES BELOW -40degC and above 100 deg C are linearly extrapolated and  increasingly inaccurate.
 *    The extrapolation was done on T vs ADC value.  If we want a more accurate table at these extreme, we should extrapolate 1/T vs ln(R) and then calculate adc values.
 *    We don't expect to need these temperatures so leaving as is  for now.
 *
 * Created: 4/22/2018 7:56:50 AM
 *  Author: GSL
 */ 
	
#include <avr/pgmspace.h>
#include <stdio.h>
#include "Globals.h"
	
// Temperature in 100ths of a degree  as a function of adc value for EPCOS B57861S103A39 in series with 10K resistor to +5V.
const int16_t adc2degC_EPCOS[1024] PROGMEM= { 
   13599, 13544, 13489, 13434, 13379, 13323, 13268, 13213, 13158, 13103,     13047, 12992, 12937, 12882, 12826, 12771, 12716, 12661, 12606, 12550,  //   0 - 19
   12495, 12440, 12385, 12330, 12274, 12219, 12164, 12109, 12053, 11998,     11943, 11888, 11833, 11777, 11722, 11667, 11612, 11556, 11501, 11446,  //   20 - 39
   11391, 11336, 11280, 11225, 11170, 11115, 11060, 11004, 10949, 10894,     10839, 10783, 10728, 10673, 10618, 10563, 10507, 10452, 10397, 10342,  //   40 - 59
   10287, 10231, 10176, 10121, 10066, 10010, 9955, 9900, 9846,      9793,     9741, 9690, 9639, 9589, 9541, 9492, 9445, 9397, 9351, 9305,  //   60 - 79
   9261, 9216, 9172, 9129, 9086, 9044, 9003, 8962, 8921, 8881,      8841, 8802, 8764, 8725, 8687, 8650, 8613, 8577, 8541, 8505,  //    80 -  99
   8470, 8435, 8400, 8366, 8332, 8299, 8266, 8233, 8200, 8169,      8137, 8105, 8074, 8043, 8013, 7982, 7952, 7922, 7892, 7863,  //   100 - 119
   7834, 7804, 7776, 7748, 7719, 7691, 7664, 7636, 7609, 7582,      7555, 7529, 7502, 7476, 7450, 7424, 7399, 7373, 7348, 7323,  //   120 - 139
   7298, 7274, 7250, 7225, 7201, 7177, 7154, 7130, 7106, 7083,      7060, 7038, 7015, 6992, 6970, 6947, 6925, 6903, 6881, 6860,  //   140 - 159
   6838, 6817, 6795, 6774, 6753, 6732, 6711, 6691, 6670, 6650,      6629, 6609, 6589, 6569, 6549, 6530, 6510, 6490, 6471, 6452,  //   160 - 179
   6433, 6413, 6394, 6375, 6357, 6338, 6319, 6301, 6282, 6264,      6246, 6228, 6210, 6192, 6174, 6156, 6138, 6121, 6103, 6086,  //   180 - 199
   6069, 6051, 6034, 6017, 6000, 5983, 5966, 5949, 5933, 5916,      5899, 5883, 5866, 5850, 5834, 5817, 5801, 5785, 5769, 5753,  //   200 - 219
   5737, 5721, 5705, 5690, 5674, 5659, 5643, 5628, 5612, 5597,      5582, 5567, 5552, 5537, 5521, 5506, 5492, 5477, 5462, 5447,  //   220 - 239
   5433, 5418, 5403, 5389, 5374, 5360, 5346, 5331, 5317, 5303,      5289, 5275, 5261, 5247, 5233, 5219, 5205, 5191, 5177, 5164,  //   240 - 259
   5150, 5136, 5123, 5109, 5096, 5082, 5069, 5056, 5042, 5029,      5016, 5002, 4989, 4976, 4963, 4950, 4937, 4924, 4911, 4898,  //   260 - 279
   4885, 4873, 4860, 4847, 4834, 4822, 4809, 4796, 4784, 4771,      4759, 4746, 4734, 4721, 4709, 4696, 4684, 4672, 4660, 4648,  //   280 - 299
   4636, 4623, 4611, 4599, 4587, 4575, 4563, 4551, 4539, 4528,      4516, 4504, 4492, 4480, 4469, 4457, 4445, 4433, 4422, 4410,  //   300 - 319
   4398, 4387, 4375, 4364, 4353, 4341, 4330, 4318, 4307, 4295,      4284, 4273, 4262, 4250, 4239, 4228, 4217, 4206, 4194, 4183,  //   320 - 339
   4172, 4161, 4150, 4139, 4128, 4117, 4106, 4096, 4085, 4074,      4063, 4052, 4042, 4031, 4020, 4009, 3998, 3988, 3977, 3966,  //   340 - 359
   3956, 3945, 3935, 3924, 3913, 3903, 3892, 3882, 3871, 3861,      3850, 3840, 3829, 3819, 3809, 3798, 3788, 3778, 3767, 3757,  //   360 - 379
   3747, 3736, 3726, 3716, 3706, 3695, 3685, 3675, 3665, 3655,      3645, 3635, 3625, 3615, 3605, 3595, 3585, 3575, 3565, 3555,  //   380 - 399
   3545, 3535, 3525, 3515, 3505, 3495, 3485, 3476, 3466, 3456,      3446, 3436, 3426, 3417, 3407, 3397, 3387, 3378, 3368, 3358,  //   400 - 419
   3349, 3339, 3329, 3320, 3310, 3300, 3291, 3281, 3272, 3262,      3253, 3243, 3233, 3224, 3214, 3205, 3195, 3186, 3176, 3167,  //   420 - 439
   3158, 3148, 3139, 3129, 3120, 3110, 3101, 3092, 3082, 3073,      3064, 3054, 3045, 3036, 3027, 3017, 3008, 2999, 2989, 2980,  //   440 - 459
   2971, 2962, 2952, 2943, 2934, 2925, 2915, 2906, 2897, 2888,      2879, 2869, 2860, 2851, 2842, 2833, 2824, 2815, 2805, 2796,  //   460 - 479
   2787, 2778, 2769, 2760, 2751, 2742, 2733, 2724, 2715, 2706,      2697, 2688, 2679, 2670, 2661, 2652, 2643, 2634, 2625, 2616,  //   480 - 499
   2607, 2598, 2589, 2580, 2571, 2562, 2553, 2544, 2535, 2526,      2517, 2508, 2500, 2491, 2482, 2473, 2464, 2455, 2446, 2437,  //   500 - 519
   2428, 2419, 2410, 2402, 2393, 2384, 2375, 2366, 2357, 2348,      2340, 2331, 2322, 2313, 2304, 2295, 2286, 2278, 2269, 2260,  //   520 - 539
   2251, 2242, 2234, 2225, 2216, 2207, 2198, 2190, 2181, 2172,      2163, 2154, 2146, 2137, 2128, 2119, 2111, 2102, 2093, 2084,  //   540 - 559
   2076, 2067, 2058, 2049, 2041, 2032, 2023, 2014, 2006, 1997,      1988, 1979, 1970, 1962, 1953, 1944, 1935, 1927, 1918, 1909,  //   560 - 579
   1900, 1892, 1883, 1874, 1865, 1857, 1848, 1839, 1830, 1822,      1813, 1804, 1795, 1787, 1778, 1769, 1760, 1751, 1743, 1734,  //   580 - 599
   1725, 1716, 1708, 1699, 1690, 1681, 1673, 1664, 1655, 1646,      1638, 1629, 1620, 1611, 1602, 1594, 1585, 1576, 1567, 1558,  //   600 - 619
   1550, 1541, 1532, 1523, 1515, 1506, 1497, 1488, 1479, 1470,      1462, 1453, 1444, 1435, 1426, 1417, 1408, 1399, 1391, 1382,  //   620 - 639
   1373, 1364, 1355, 1346, 1337, 1328, 1319, 1310, 1302, 1293,      1284, 1275, 1266, 1257, 1248, 1239, 1230, 1221, 1212, 1203,  //   640 - 659
   1194, 1185, 1176, 1167, 1158, 1149, 1140, 1131, 1122, 1113,      1104, 1095, 1086, 1077, 1068, 1059, 1050, 1041, 1032, 1022,  //   660 - 679
   1013, 1004,  995,  986,  977,  968,  958,  949,  940,  931,       921,  912,  903,  894,  884,  875,  866,  857,  847,  838,  //   680 - 699
   829,  819,  810,  801,  791,  782,  773,  763,  754,  744,       735,  726,  716,  707,  697,  688,  678,  669,  659,  650,  //   700 - 719
   640,  631,  621,  612,  602,  593,  583,  573,  564,  554,       544,  535,  525,  515,  506,  496,  486,  476,  467,  457,  //   720 - 739
   447,  437,  427,  417,  408,  398,  388,  378,  368,  358,       348,  338,  328,  318,  308,  298,  288,  278,  268,  257,  //   740 - 759
   247,  237,  227,  217,  207,  197,  186,  176,  166,  155,       145,  135,  124,  114,  104,   93,   83,   72,   62,   51,  //   760 - 779
   41,   30,   20,    9,   -1,  -11,  -22,  -33,  -44,  -54,        -65,  -76,  -87,  -98, -109, -120, -131, -142, -153, -164,  //   780 - 799
   -175, -186, -197, -208, -219, -230, -242, -253, -264, -275,      -287, -298, -310, -321, -333, -344, -356, -367, -379, -390,  //   800 - 819
   -402, -414, -425, -437, -449, -461, -473, -484, -496, -500,      -501, -503, -504, -505, -506, -507, -508, -509, -510, -512,  //   820 - 839
   -513, -514, -515, -516, -517, -518, -519, -521, -522, -523,      -524, -525, -526, -527, -528, -530, -531, -532, -533, -534,  //   840 - 859
   -535, -536, -537, -539, -540, -541, -542, -543, -544, -545,      -546, -548, -549, -550, -551, -552, -553, -554, -555, -557,  //   860 - 879
   -558, -559, -560, -561, -562, -563, -564, -566, -567, -568,      -569, -570, -571, -572, -573, -575, -576, -577, -578, -579,  //   880 - 899
   -580, -581, -582, -584, -585, -586, -587, -588, -589, -590,      -591, -593, -594, -595, -596, -597, -598, -599, -710, -835,  //   900 - 919
   -960,-1085, -1209,-1334,-1458,-1582,-1706,-1831,-1955,-2012,    -2033,-2053,-2073,-2094,-2115,-2136,-2157,-2178,-2199,-2221,  //   920 - 939
   -2243,-2265,-2287,-2310,-2333,-2356,-2379,-2402,-2426,-2450,    -2474,-2498,-2523,-2548,-2573,-2599,-2625,-2651,-2678,-2704,  //   940 - 959
   -2732,-2759,-2787,-2815,-2844,-2873,-2902,-2932,-2962,-2992,    -3024,-3056,-3088,-3121,-3154,-3188,-3222,-3258,-3293,-3330,  //   960 - 979
   -3367,-3404,-3443,-3482,-3522,-3565,-3608,-3653,-3698,-3744,    -3791,-3841,-3890,-3942,-3994,-4046,-4098,-4150,-4202,-4254,  //   980 - 999
   -4306,-4358,-4410,-4463,-4515,-4567,-4619,-4671,-4723,-4775,    -4827,-4879,-4931,-4983,-5036,-5088,-5140,-5192,-5244,-5296,  //  1000 - 1019
   -5348,-5400,-5452,-5504   };                                                                                                  //  1020 - 1023

																																																											
/**********************************************************************
 *
 *  return temperature in 100ths of a deg C, given ADC Value. 
 *     code assumes monotonically decreasing table.  
 *     if increasing change:
 *               - (  (  (pgm_read_word(&adc2degC_EPCOS[adcAve]) -  pgm_read_word(&adc2degC_EPCOS[adcAve+1]) ) ...
 *            to + (  ((pgm_read_word(&adc2degC_EPCOS[adcAve+1]) -  pgm_read_word(&adc2degC_EPCOS[adcAve])   ) ...
 *
 **********************************************************************/
int16_t convertADCtoDegC(uint32_t adcSum)
{
	uint16_t adcAve = adcSum >> ADC_SUM_SHIFT; 
	uint16_t  degC =  pgm_read_word(&adc2degC_EPCOS[adcAve]) 
	                  - (  (  (pgm_read_word(&adc2degC_EPCOS[adcAve]) -  pgm_read_word(&adc2degC_EPCOS[adcAve+1]) ) 
						     * (adcSum & (NUM_ADC_SUMS - 1)) + (1<<(ADC_SUM_SHIFT-1)) 	)  >> ADC_SUM_SHIFT ) ;
	// interpolate between values.  

//	if (adcAve<1023)  // won't work at adcAve = 1023. don't think the op amp will saturate so this shoudl be unnecessary.
	
	return  degC;
}

/*
int16_t convertADCtoDegC_2(uint32_t adcSum)
{
	uint16_t adcAve = adcSum >> ADC_SUM_SHIFT;
	uint16_t  degC =  pgm_read_word(&adc2degC_EPCOS[adcAve]) +
	(
	(  (pgm_read_word(&adc2degC_EPCOS[adcAve+1]) -  pgm_read_word(&adc2degC_EPCOS[adcAve]))
	* (adcSum & (NUM_ADC_SUMS - 1))  + (1<<(ADC_SUM_SHIFT-1)) )  >> ADC_SUM_SHIFT ) ;
	// interpolate between values.

printf("%lu %d %d %d %d %d %d ",adcSum, (uint16_t) ((adcSum) >> ADC_SUM_SHIFT), (uint16_t) (adcSum & (NUM_ADC_SUMS - 1)), 
				 pgm_read_word(&adc2degC_EPCOS[adcAve]), pgm_read_word(&adc2degC_EPCOS[adcAve+1]),
				  (pgm_read_word(&adc2degC_EPCOS[adcAve+1]) - pgm_read_word(&adc2degC_EPCOS[adcAve])) *(adcAve & (NUM_ADC_SUMS - 1)),
				  degC
			);

	//	if (adcAve<1023)  // won't work at adcAve = 1023. don't think the op amp will saturate so this should be unnecessary.
	
	return  degC;
}

*/

/*Eliminate this?
/ binary search to find closest degC in adc2degC table.  Search assumes table MONTONICALLY DECREASES!!  */
/*
int16_t convertDegCtoADC(int16_t adcval)
{
				
	int16_t low, high, mid;
	int16_t midVal;
				
	low = 0;
	high = 1023;
	while (low != (high -1))
	{
		mid = (low + high) /2;
		midVal = pgm_read_word(&adc2degC_EPCOS[mid]);
		if (adcval > midVal)
		{
			high = mid;
		}
		else if (adcval < midVal)
		{
			low = mid;
		}
		else
		{
			return mid;
		}
	}
	if ( (adcval - pgm_read_word(&adc2degC_EPCOS[high]) ) < (pgm_read_word(&adc2degC_EPCOS[low])-adcval ))
		return high;
	else
		return low;
}
*/

/******************************************************************************
 *
 *  IGOR CODE TO GENERATE ABOVE LOOK UP TABLE!!
 *
 *****************************************************************************/
/*
// fit_lnRvslnT()-- do linear interpolation between data points (from spec sheet) on ln(R) vs 1/T.  This assumes the function form of the thermistor curve is ln(R) = Beta/T + ln(R_inf),
// spec sheet for Semitec thermistors is here: http://semitec-usa.com/pdf/NTCThermistor_AT.pdf
/  SPec sheet for EPCOS B57861S103A39

function fit_LnRvsInvT()

make /o/n=29  DataR, DataT

DataT = { -40,      -35,		-30,	-25,     -20,   15,  -10,    -5,     0,     5,   10,    15,    20,     25,   30,   35,       40,    45,     50,      55,     60,    65,       70,      75,       80,     85,      90,     95,      100}

//nominal Resistance of Semitec 103AT-4-70261 thermistors, from data sheet
//	DataR ={ 188.5,  144.1,  111.3,   86.43,  7.77, 3.41, 42.47, 33.9, 27.28 , 22.05,17.96,  14.69, 12.09, 10.00, 8.313, 6.940, 5.827, 4.911, 4.160, 3.536, 3.020, 2.588, 2.228, 1.924, 1.668, 1.451, 1.266, 1.108, 0.9731}
//	DataR*= 1000
//nominal Resistance of EPCOS B57861S103A39 thermistors, from data sheet
DataR ={ 332600, 242600, 177000, 130400, 97070, 72930, 55330, 42320, 32650, 25390,19900, 15710, 12490, 10000, 8057,  6531, 5327,    4369, 3603, 2986, 2488,  2083, 1752, 1481, 1258, 1072, 917.7, 788.5, 680}

duplicate /o DataT   lnR, lnvT

make /o/n=141 fitR,ADCvalues, Tx

lnR = ln(DataR[p])
lnvT = 1/(DataT[p] + 273.15)

variable i,j, R, T, slope

for (T=-40, j=0; T<=100; T+=1, j+=1)
	Tx[j] = T;
	i = 1/(T+273.15);
	fitR[j] = exp(  interp( i, lnvT, lnR));
	ADCvalues[j] =  fitR[j]/(10000 + fitR[j]) * 1024
	if (mod(j,10) == 0)
		printf "\r%d  ", j
	endif
	if (fitR[j]<1000)
		printf  "%3.3f, ",  fitR[j]
	elseif (fitR[j]<10000)
		printf  "%4.2f, ",  fitR[j]
	elseif (fitR[j]<32000)
		printf  "%5.1f, ", fitR[j]
	else
		printf  "%d,- ",  round(fitR[j])
	endif
endfor
print "\n"
setScale  /P x, -40, 1, fitR, ADCvalues

printf "{"
	//   	   for (j= ceil(ADCvalues[0]); j<floor(ADCvalues[inf]); j+=1)
	for (j= 0; j<1024; j+=1)
	if (mod(j ,20) ==0)
	printf  "  //   %d - %d\r ", j-20, j-1
	endif
	if (mod(j ,20) ==10)
	printf  "    "
	
	endif
	printf " %d,", interp(j,ADCvalues,Tx)*100

	//     	   	   printf " %.2f,", interp(j,ADCvalues,Tx)
	endfor
print " }; //1020-1023\n"

*/